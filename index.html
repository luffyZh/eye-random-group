<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>中央随机化分配模拟工具</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f6fa; }
    .container { max-width: 950px; margin: 30px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ececec; padding: 24px; }
    .form-group { margin-bottom: 16px; }
    .label { display: inline-block; min-width: 90px; font-weight: bold; }
    input, select { padding: 3px 8px; }
    .group-input { width: 45px; }
    .btn { padding: 4px 14px; border: none; border-radius: 4px; background: #3478f7; color: #fff; cursor: pointer; font-size: 14px;}
    .result-table { width: 100%; border-collapse: collapse; margin-top: 18px; }
    .result-table th, .result-table td { border: 1px solid #e3e6ef; padding: 7px 3px; font-size: 14px; text-align: center;}
    .result-table th { background: #f3f4f8; }
    .tag { display:inline-block; background: #f0f2f7; color: #3478f7; border-radius: 3px; padding: 1px 7px; margin-right: 3px; font-size:13px;}
    .dim-label { color:#666; font-size:13px; }
    .row { display:flex; gap:14px; }
  </style>
</head>
<body>
<div class="container">
  <div style="font-size:18px; font-weight:bold; margin-bottom:18px;">中央随机化分组分配模拟</div>
  <!-- 配置区 -->
  <div class="form-group">
    <span class="label">项目名称:</span>
    <input type="text" id="projectName" value="青少年近视分组研究">
  </div>
  <div class="form-group">
    <span class="label">参与人数:</span>
    <input type="number" id="totalNum" value="100" min="2" max="500">
  </div>
  <div class="form-group">
    <span class="label">分组数量:</span>
    <select id="groupNum" onchange="renderGroupInputs()">
      <option value="2" selected>2组</option>
      <option value="3">3组</option>
      <option value="4">4组</option>
    </select>
    <span class="label">分组比例:</span>
    <span id="groupInputs"></span>
  </div>
  <div class="form-group">
    <span class="label">随机方式:</span>
    <select id="randType">
      <option value="simple">完全随机</option>
      <option value="stratified">自定义分层随机</option>
    </select>
  </div>
  <div class="form-group">
    <span class="label">维度设置:</span>
    <span class="dim-label">年龄[6-8, 9-11, 12-14]；性别[男, 女]；屈光度[0~200, 201~400]</span>
    <br><span style="color:#aaa;font-size:12px;">（默认三维组合，适合演示）</span>
  </div>
  <div class="form-group">
    <button class="btn" onclick="doAllocate()">分配</button>
  </div>

  <!-- 结果展示 -->
  <div id="result"></div>
</div>
<script>
  // 维度设置
  const ages = ['6-8', '9-11', '12-14'];
  const genders = ['男', '女'];
  const degrees = ['0~200', '201~400'];
  // 动态渲染分组比例输入
  function renderGroupInputs() {
    let groupNum = Number(document.getElementById('groupNum').value);
    let html = '';
    for(let i=0; i<groupNum; i++) {
      html += `<input type="number" class="group-input" id="groupRatio${i}" value="1" min="1">`;
      html += `<span class="tag">组${String.fromCharCode(65+i)}</span>`;
    }
    document.getElementById('groupInputs').innerHTML = html;
  }
  renderGroupInputs();

  // 生成样本
  function genSamples(total) {
    let samples = [];
    let i = 0;
    while(samples.length < total) {
      let age = ages[Math.floor(Math.random()*ages.length)];
      let gender = genders[Math.floor(Math.random()*genders.length)];
      let degree = degrees[Math.floor(Math.random()*degrees.length)];
      samples.push({
        id: ++i,
        name: `受试者${i}`,
        gender,
        age,
        degree
      });
    }
    return samples;
  }

  // 分层分组
  function stratifiedAllocate(samples, groupNum, ratios) {
    // 统计每个分层下的样本
    let stratums = {};
    samples.forEach(s => {
      let key = `${s.gender}|${s.age}|${s.degree}`;
      if(!stratums[key]) stratums[key] = [];
      stratums[key].push(s);
    });
    // 每层分组配额
    let stratumKeys = Object.keys(stratums);
    let result = {};  // groupName -> []
    for(let i=0; i<groupNum; i++) result[`组${String.fromCharCode(65+i)}`] = [];
    stratumKeys.forEach(key => {
      let arr = stratums[key];
      let total = arr.length;
      let groupQuota = ratios.map(r => Math.floor(total * r / ratios.reduce((a,b)=>a+b)));
      // 补齐四舍五入误差
      let sum = groupQuota.reduce((a,b)=>a+b), diff = total-sum;
      for(let i=0; i<diff; i++) groupQuota[i%groupQuota.length]++;
      // shuffle
      arr.sort(()=>Math.random()-0.5);
      let idx = 0;
      for(let g=0; g<groupNum; g++) {
        let gn = `组${String.fromCharCode(65+g)}`;
        for(let k=0; k<groupQuota[g]; k++) {
          let s = arr[idx++];
          if(s) { s.group = gn; result[gn].push(s); }
        }
      }
    });
    return result;
  }

  // 完全随机分配
  function simpleRandomAllocate(samples, groupNum, ratios) {
    let total = samples.length;
    let groupQuota = ratios.map(r => Math.floor(total * r / ratios.reduce((a,b)=>a+b)));
    // 补齐误差
    let sum = groupQuota.reduce((a,b)=>a+b), diff = total-sum;
    for(let i=0; i<diff; i++) groupQuota[i%groupNum]++;
    // shuffle
    samples.sort(()=>Math.random()-0.5);
    let result = {}; for(let i=0; i<groupNum; i++) result[`组${String.fromCharCode(65+i)}`]=[];
    let idx = 0;
    for(let g=0; g<groupNum; g++) {
      let gn = `组${String.fromCharCode(65+g)}`;
      for(let k=0; k<groupQuota[g]; k++) {
        let s = samples[idx++];
        if(s) { s.group = gn; result[gn].push(s);}
      }
    }
    return result;
  }

  function doAllocate() {
    let projectName = document.getElementById('projectName').value;
    let totalNum = Number(document.getElementById('totalNum').value);
    let groupNum = Number(document.getElementById('groupNum').value);
    let ratios = [];
    for(let i=0; i<groupNum; i++) ratios.push(Number(document.getElementById('groupRatio'+i).value));
    let randType = document.getElementById('randType').value;
    let samples = genSamples(totalNum);
    let result = {};
    if(randType === 'stratified') {
      result = stratifiedAllocate(samples, groupNum, ratios);
    } else {
      result = simpleRandomAllocate(samples, groupNum, ratios);
    }
    // 展示
    let html = `<div style="margin:20px 0;font-weight:bold;font-size:16px;">${projectName} 分配结果 (${randType==='simple'?'完全随机':'分层随机'})</div>`;
    html += `<table class="result-table"><thead><tr><th style="width:120px;">组别</th><th style="width:80px;">人数</th><th>样本明细（部分）</th></tr></thead><tbody>`;
    Object.keys(result).forEach(gn => {
      let arr = result[gn];
      let detail = arr.map(s=>`<span style="display:inline-block;padding:2px 6px;margin:2px;background:#f0f2f7;border-radius:3px;">${s.name}-${s.gender}-${s.age}-${s.degree}</span>`);
      html += `<tr><td>${gn}</td><td>${arr.length}</td><td>${detail}</td></tr>`;
    });
    html += `</tbody></table>`;

    // 分层分布统计
    if(randType==='stratified') {
      html += `<div style="margin:18px 0 6px 0;font-weight:bold;">分层分组统计（每个分层在各组人数）</div>`;
      html += `<table class="result-table"><thead><tr><th>性别</th><th>年龄</th><th>屈光度</th>`;
      for(let i=0;i<groupNum;i++) html += `<th>组${String.fromCharCode(65+i)}</th>`;
      html += `</tr></thead><tbody>`;
      for(let g of genders) for(let a of ages) for(let d of degrees) {
        html += `<tr><td>${g}</td><td>${a}</td><td>${d}</td>`;
        for(let i=0;i<groupNum;i++) {
          let gn = `组${String.fromCharCode(65+i)}`;
          let cnt = result[gn].filter(s=>s.gender===g&&s.age===a&&s.degree===d).length;
          html += `<td>${cnt}</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody></table>`;
    }

    document.getElementById('result').innerHTML = html;
  }
</script>
</body>
</html>